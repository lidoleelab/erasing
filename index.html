<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Residual Birth by Digitizing</title>

<!-- (선택) 파형 미리 뜨는 속도 개선 -->
<link rel="preload" as="audio" href="audio/01_original.mp3" type="audio/mpeg">
<link rel="preload" as="audio" href="audio/02_denoised.mp3" type="audio/mpeg">
<link rel="preload" as="audio" href="audio/03_no_noise_no_bgm.mp3" type="audio/mpeg">
<link rel="preload" as="audio" href="audio/04_residual.mp3" type="audio/mpeg">

<style>
:root{
  --bg:#ffffff;
  --ui:#666;
  --track:#e0e0e0;
  --fill:#888;
  --thumb:#888;
}
*{ box-sizing:border-box; }

body{
  margin:0;
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  background: var(--bg);
  color:#111;
}

.wrap{
  max-width: 860px;
  margin: 40px auto;
  padding: 0 16px 40px;
}

.stack{
  display: grid;
  grid-template-columns: 1fr;
  gap: 28px;
}

/* ===== PLAYER LAYOUT ===== */
.player{
  display: grid;
  grid-template-columns: auto auto 1fr auto auto; /* play | current | seek+amp | dur | volume */
  align-items: center;
  gap: 14px;
  width: 100%;
  padding-bottom: 12px;
}

.btn{
  border: none;
  background: transparent;
  padding: 0;
  cursor: pointer;
}

.btn svg{
  width: 24px;
  height: 24px;
  fill: var(--ui);
}

.time, .dur{
  font-variant-numeric: tabular-nums;
  color: var(--ui);
  font-size: 14px;
  min-width: 46px;
}

/* seek + amplitude stack */
.seekwrap{
  display: grid;
  gap: 10px;
  align-items: center;
  min-width: 0;
}

/* slider */
.range{
  width: 100%;
  -webkit-appearance: none;
  appearance: none;
  height: 6px;
  border-radius: 999px;
  background: linear-gradient(to right,
    var(--fill) 0%,
    var(--fill) var(--pct,0%),
    var(--track) var(--pct,0%),
    var(--track) 100%);
  outline: none;
}

.range::-webkit-slider-thumb{
  -webkit-appearance: none;
  width: 14px;
  height: 14px;
  border-radius: 999px;
  background: var(--thumb);
  cursor: pointer;
}
.range::-moz-range-thumb{
  width: 14px;
  height: 14px;
  border-radius: 999px;
  background: var(--thumb);
  cursor: pointer;
}

/* amplitude canvas */
.wave{
  width: 100%;
  height: 26px;
  display: block;
  border-radius: 6px;
  background: transparent;
  cursor: pointer;
}

/* ===== VOLUME GROUP (THIS IS WHAT WE HIDE ON MOBILE) ===== */
.volume{
  display: inline-grid;
  grid-template-columns: auto 120px;
  gap: 10px;
  align-items: center;
  justify-content: end;
}

.volume .icon{
  display: inline-flex;
  align-items: center;
  justify-content: center;
}

.volume .icon svg{
  width: 20px;
  height: 20px;
  fill: var(--ui);
}

.volume .vol{
  width: 120px;
}

/* ===== MOBILE: REMOVE VOLUME ONLY ===== */
@media (max-width: 768px){
  .player{
    grid-template-columns: auto auto 1fr auto; /* volume column removed */
    gap: 10px;
  }
  .volume{
    display: none !important; /* ✅ 모바일에서만 볼륨 완전 제거 */
  }
  .wave{
    height: 28px; /* (선택) 모바일에서 살짝 두껍게 */
  }
}
</style>
</head>

<body>
<div class="wrap">
  <section class="stack">

    <!-- PLAYER 1 -->
    <div class="player" data-player>
      <button class="btn" data-play aria-label="play/pause">
        <svg viewBox="0 0 24 24" data-ico><path d="M8 5v14l11-7z"/></svg>
      </button>

      <div class="time" data-current>0:00</div>

      <div class="seekwrap">
        <input class="range" type="range" min="0" max="100" value="0" step="0.1" data-seek>
        <canvas class="wave" height="26" data-wave></canvas>
      </div>

      <div class="dur" data-duration>0:00</div>

      <div class="volume">
        <span class="icon" aria-hidden="true">
          <svg viewBox="0 0 24 24">
            <path d="M3 10v4h4l5 4V6L7 10H3zm13.5 2a3.5 3.5 0 0 0-2-3.16v6.32A3.5 3.5 0 0 0 16.5 12zm0-7a8.5 8.5 0 0 1 0 14v-2a6.5 6.5 0 0 0 0-10V5z"/>
          </svg>
        </span>
        <input class="range vol" type="range" min="0" max="1" value="1" step="0.01" data-vol aria-label="volume">
      </div>

      <audio preload="metadata" data-audio>
        <source src="audio/01_original.mp3" type="audio/mpeg">
      </audio>
    </div>

    <!-- PLAYER 2 -->
    <div class="player" data-player>
      <button class="btn" data-play aria-label="play/pause">
        <svg viewBox="0 0 24 24" data-ico><path d="M8 5v14l11-7z"/></svg>
      </button>

      <div class="time" data-current>0:00</div>

      <div class="seekwrap">
        <input class="range" type="range" min="0" max="100" value="0" step="0.1" data-seek>
        <canvas class="wave" height="26" data-wave></canvas>
      </div>

      <div class="dur" data-duration>0:00</div>

      <div class="volume">
        <span class="icon" aria-hidden="true">
          <svg viewBox="0 0 24 24">
            <path d="M3 10v4h4l5 4V6L7 10H3zm13.5 2a3.5 3.5 0 0 0-2-3.16v6.32A3.5 3.5 0 0 0 16.5 12zm0-7a8.5 8.5 0 0 1 0 14v-2a6.5 6.5 0 0 0 0-10V5z"/>
          </svg>
        </span>
        <input class="range vol" type="range" min="0" max="1" value="1" step="0.01" data-vol aria-label="volume">
      </div>

      <audio preload="metadata" data-audio>
        <source src="audio/02_denoised.mp3" type="audio/mpeg">
      </audio>
    </div>

    <!-- PLAYER 3 -->
    <div class="player" data-player>
      <button class="btn" data-play aria-label="play/pause">
        <svg viewBox="0 0 24 24" data-ico><path d="M8 5v14l11-7z"/></svg>
      </button>

      <div class="time" data-current>0:00</div>

      <div class="seekwrap">
        <input class="range" type="range" min="0" max="100" value="0" step="0.1" data-seek>
        <canvas class="wave" height="26" data-wave></canvas>
      </div>

      <div class="dur" data-duration>0:00</div>

      <div class="volume">
        <span class="icon" aria-hidden="true">
          <svg viewBox="0 0 24 24">
            <path d="M3 10v4h4l5 4V6L7 10H3zm13.5 2a3.5 3.5 0 0 0-2-3.16v6.32A3.5 3.5 0 0 0 16.5 12zm0-7a8.5 8.5 0 0 1 0 14v-2a6.5 6.5 0 0 0 0-10V5z"/>
          </svg>
        </span>
        <input class="range vol" type="range" min="0" max="1" value="1" step="0.01" data-vol aria-label="volume">
      </div>

      <audio preload="metadata" data-audio>
        <source src="audio/03_no_noise_no_bgm.mp3" type="audio/mpeg">
      </audio>
    </div>

    <!-- PLAYER 4 -->
    <div class="player" data-player>
      <button class="btn" data-play aria-label="play/pause">
        <svg viewBox="0 0 24 24" data-ico><path d="M8 5v14l11-7z"/></svg>
      </button>

      <div class="time" data-current>0:00</div>

      <div class="seekwrap">
        <input class="range" type="range" min="0" max="100" value="0" step="0.1" data-seek>
        <canvas class="wave" height="26" data-wave></canvas>
      </div>

      <div class="dur" data-duration>0:00</div>

      <div class="volume">
        <span class="icon" aria-hidden="true">
          <svg viewBox="0 0 24 24">
            <path d="M3 10v4h4l5 4V6L7 10H3zm13.5 2a3.5 3.5 0 0 0-2-3.16v6.32A3.5 3.5 0 0 0 16.5 12zm0-7a8.5 8.5 0 0 1 0 14v-2a6.5 6.5 0 0 0 0-10V5z"/>
          </svg>
        </span>
        <input class="range vol" type="range" min="0" max="1" value="1" step="0.01" data-vol aria-label="volume">
      </div>

      <audio preload="metadata" data-audio>
        <source src="audio/04_residual.mp3" type="audio/mpeg">
      </audio>
    </div>

  </section>
</div>

<script>
/* ===== helpers ===== */
const fmtTime = (sec) => {
  sec = Math.max(0, sec || 0);
  const m = Math.floor(sec / 60);
  const s = Math.floor(sec % 60);
  return `${m}:${String(s).padStart(2,'0')}`;
};
const setPct = (el,p)=>el.style.setProperty('--pct',`${p}%`);

let audioCtx = null;
function getCtx(){
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  return audioCtx;
}

/* ===== waveform (thin bars) ===== */
const waveformCache = new Map();
const PEAKS = 1200;

function drawPlaceholder(canvas){
  const dpr = Math.max(1, devicePixelRatio || 1);
  const W = Math.max(1, canvas.clientWidth || 1);
  const H = Math.max(1, canvas.clientHeight || 26);
  canvas.width = Math.floor(W*dpr);
  canvas.height = Math.floor(H*dpr);
  const g = canvas.getContext("2d");
  g.setTransform(dpr,0,0,dpr,0,0);
  g.clearRect(0,0,W,H);
  g.fillStyle = "#e2e2e2";
  g.fillRect(0, Math.floor(H/2), W, 1);
}

function drawBars(canvas, peaks, progress01=0){
  const dpr = Math.max(1, devicePixelRatio || 1);
  const W = Math.max(1, canvas.clientWidth || 1);
  const H = Math.max(1, canvas.clientHeight || 26);
  canvas.width = Math.floor(W*dpr);
  canvas.height = Math.floor(H*dpr);

  const g = canvas.getContext("2d");
  g.setTransform(dpr,0,0,dpr,0,0);
  g.clearRect(0,0,W,H);

  const mid = H/2;
  const base = "#cfcfcf";
  const played = "#888";
  const playhead = "#666";

  const barCount = Math.max(90, Math.min(520, Math.floor(W/3)));
  const N = peaks.length;
  const barW = W / barCount;
  const w = Math.max(1, barW * 0.55);

  for (let i=0;i<barCount;i++){
    const t = i/(barCount-1);
    const idx = Math.min(N-1, Math.floor(t*(N-1)));
    const p = peaks[idx];
    const h = Math.max(1, p * (H*0.9));
    const x = i*barW + (barW-w)/2;
    const y = mid - h/2;
    g.fillStyle = (t<=progress01) ? played : base;
    g.fillRect(x,y,w,h);
  }

  const px = progress01*W;
  g.fillStyle = playhead;
  g.fillRect(px,0,1,H);
}

function computePeaks(channelData, count){
  const len = channelData.length;
  const block = Math.floor(len / count) || 1;
  const out = new Float32Array(count);
  for (let i=0;i<count;i++){
    const start = i*block;
    const end = Math.min(start+block, len);
    let max=0;
    for (let j=start;j<end;j++){
      const v = Math.abs(channelData[j]);
      if (v>max) max=v;
    }
    out[i]=max;
  }
  return out;
}

async function ensureWaveform(audioEl, canvas){
  const src = audioEl.querySelector("source")?.getAttribute("src") || audioEl.currentSrc;
  if (!src) return null;

  drawPlaceholder(canvas);

  if (waveformCache.has(src)){
    const peaks = waveformCache.get(src);
    drawBars(canvas, peaks, 0);
    return (p01)=>drawBars(canvas, peaks, p01);
  }

  const ctx = getCtx();
  const res = await fetch(src, { cache: "force-cache" });
  const arr = await res.arrayBuffer();
  const buf = await ctx.decodeAudioData(arr);
  const peaks = computePeaks(buf.getChannelData(0), PEAKS);
  waveformCache.set(src, peaks);

  drawBars(canvas, peaks, 0);
  return (p01)=>drawBars(canvas, peaks, p01);
}

/* ===== players ===== */
const allAudios = [];
document.querySelectorAll("[data-player]").forEach(root=>{
  const audio = root.querySelector("[data-audio]");
  const playBtn = root.querySelector("[data-play]");
  const ico = root.querySelector("[data-ico]");
  const seek = root.querySelector("[data-seek]");
  const vol = root.querySelector("[data-vol]");
  const cur = root.querySelector("[data-current]");
  const dur = root.querySelector("[data-duration]");
  const wave = root.querySelector("[data-wave]");

  allAudios.push(audio);
  if (vol) setPct(vol, Number(vol.value)*100);

  let redraw = null;
  ensureWaveform(audio, wave).then(fn => { redraw = fn; }).catch(()=>{});

  audio.addEventListener("loadedmetadata", ()=>{
    dur.textContent = fmtTime(audio.duration);
    if (redraw) redraw(0);
  });

  audio.addEventListener("timeupdate", ()=>{
    cur.textContent = fmtTime(audio.currentTime);
    const p = audio.duration ? (audio.currentTime/audio.duration)*100 : 0;
    seek.value = p;
    setPct(seek, p);
    if (redraw){
      const p01 = audio.duration ? (audio.currentTime/audio.duration) : 0;
      redraw(p01);
    }
  });

  audio.addEventListener("play", ()=>{
    allAudios.forEach(a=>{ if (a!==audio && !a.paused) a.pause(); });
    ico.innerHTML = '<path d="M6 5h4v14H6zm8 0h4v14h-4z"/>';
  });

  audio.addEventListener("pause", ()=>{
    ico.innerHTML = '<path d="M8 5v14l11-7z"/>';
  });

  playBtn.addEventListener("click", async ()=>{
    // iOS 정책 대응(재생 시점에 resume)
    const ctx = getCtx();
    if (ctx.state === "suspended") { try{ await ctx.resume(); }catch{} }
    audio.paused ? audio.play() : audio.pause();
  });

  seek.addEventListener("input", ()=>{
    const t = (seek.value/100) * (audio.duration || 0);
    cur.textContent = fmtTime(t);
    setPct(seek, seek.value);
    if (redraw) redraw(seek.value/100);
  });

  seek.addEventListener("change", ()=>{
    audio.currentTime = (seek.value/100) * (audio.duration || 0);
  });

  wave.addEventListener("click", (e)=>{
    if (!audio.duration) return;
    const r = wave.getBoundingClientRect();
    const x = Math.max(0, Math.min(r.width, e.clientX - r.left));
    const p01 = r.width ? x/r.width : 0;
    audio.currentTime = p01 * audio.duration;
  });

  if (vol){
    vol.addEventListener("input", ()=>{
      const v = Number(vol.value);
      audio.volume = v;
      setPct(vol, v*100);
    });
  }
});

// 캔버스 폭 0/리사이즈 이슈 방지: 로드 후 한번 redraw 트리거
window.addEventListener("load", ()=>{ setTimeout(()=>window.dispatchEvent(new Event("resize")), 200); });
window.addEventListener("resize", ()=>{
  document.querySelectorAll("[data-player]").forEach(root=>{
    const audio = root.querySelector("[data-audio]");
    const wave = root.querySelector("[data-wave]");
    const src = audio.querySelector("source")?.getAttribute("src") || audio.currentSrc;
    if (!src) return;
    const peaks = waveformCache.get(src);
    if (!peaks){
      drawPlaceholder(wave);
      return;
    }
    const p01 = audio.duration ? (audio.currentTime/audio.duration) : 0;
    drawBars(wave, peaks, p01);
  });
});
</script>

</body>
</html>
